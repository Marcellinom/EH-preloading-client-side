<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        #gdt{background:#EDEBDF;border:1px solid #5C0D12;text-align:left;min-width:720px;max-width:1200px;margin:0 auto;clear:both;padding:5px;border-radius:9px}
        #gdt div{text-align:center;float:left;margin:2px 0px;width:120px}
    </style>
</head>
<body>
    <input id="eh-link" placeholder="e-h link"><button id="search" onclick="start(document.getElementById('eh-link').value)">Search</button>
    <div id="gdt"></div>
    <script>
        var galleries = []
        async function run(url) {
            let res = await fetch("https://api.allorigins.win/get?url="+encodeURIComponent(url))
            let text = await res.json()
            const dom = new DOMParser()
            let parsed = dom.parseFromString(text.contents.replace(/\\./g, ""), 'text/html')
            let pages = parsed.getElementsByClassName('gdtm')
            galleries = [...galleries, ...pages]

            let token = ''
            for (let i = 0; i < pages.length; i++) token += `${pages[i].childNodes[0].childNodes[0].href.split('/s/')[1].split('/')[0]},`
            return token
        }

        function write(tokens, max)
        {
            let id = galleries[0].childNodes[0].childNodes[0].href.split('/s/')[1].split('/')[1].replace('-1','')

            let base_href = `/page?token=${tokens.slice(0,-1)}&id=${id}&max=${max}`
            for (let i = 0; i < galleries.length; i++) {
                galleries[i].childNodes[0].childNodes[0].href = `${base_href}&page=${i+1}`
                document.getElementById('gdt').appendChild(galleries[i].childNodes[0])
            }
        }

        async function start(url) {
            if (url[url.length-1] === '/' || url[url.length-1] === '\\') url[url.length-1] = ''
            let ids = url.split('/g/')[1]
            let res = await fetch("https://api.e-hentai.org/api.php", {
                method: 'post',
                body: JSON.stringify({
                "method": "gdata",
                "gidlist": [
                    ids.split('/')
                ]
                })
            })
            let info = await res.json()
            let token = ''
            for (let i = 0; i < Math.ceil(info.gmetadata[0].filecount / 40); i++) token += await run(`${url}?p=${i}`)
            write(token, info.gmetadata[0].filecount)
        }
    </script>
</body>
</html>